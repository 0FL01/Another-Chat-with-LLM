# Blueprint: Mistral Structured Output Refactoring

**Status**: Draft
**Feature**: Mistral JSON Mode & Simulated Tool Calling
**Parent Context**: `backlog/docs/mistral/structure-output/`

## Context & Objective
–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è `MistralProvider` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–∞—Ç–∏–≤–Ω—ã–π Function Calling API. –ó–∞–¥–∞—á–∞ ‚Äî –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –∞–≥–µ–Ω—Ç—Å–∫–∏–π —Ä–µ–∂–∏–º (`chat_with_tools`) –Ω–∞ **Structured Output (JSON Mode)**. –≠—Ç–æ –ø–æ–≤—ã—Å–∏—Ç –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å —Å–ª–µ–¥–æ–≤–∞–Ω–∏—è —Å—Ö–µ–º–µ (–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –≤ `composer.rs`) –∏ —É–Ω–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Å –º–æ–¥–µ–ª—è–º–∏ –±–µ–∑ –Ω–∞—Ç–∏–≤–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤.

**Key Changes:**
1.  **API Payload**: –ó–∞–º–µ–Ω–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `tools` –Ω–∞ `response_format: { "type": "json_object" }`.
2.  **History Handling**: –õ–∏–Ω–µ–∞—Ä–∏–∑–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π. –†–æ–ª—å `tool` –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –≤ `user`, —Ç–∞–∫ –∫–∞–∫ –±–µ–∑ –Ω–∞—Ç–∏–≤–Ω–æ–≥–æ `tool_calls` API –º–æ–∂–µ—Ç –æ—Ç–≤–µ—Ä–≥–Ω—É—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ä–æ–ª—å—é `tool`.
3.  **Embeddings**: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ `generate_embedding`.

---

## Phase 1: Validation & Discovery [x]

**Goal**: –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é API Mistral –¥–ª—è JSON mode –∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Ç–µ–∫—É—â–∏–º HTTP-–∫–ª–∏–µ–Ω—Ç–æ–º.

**Resource Context**:
- üìÑ `src/llm/providers.rs`
- üìö **Docs**: Mistral API `response_format`, `v1/chat/completions`

**Steps**:
1. [x] **Verify API Specs**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `tavily_search` —Å –∑–∞–ø—Ä–æ—Å–æ–º "Mistral API chat completion json mode response_format parameter", —á—Ç–æ–±—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Ç–æ—á–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å (–æ—Å–æ–±–µ–Ω–Ω–æ –¥–ª—è –º–æ–¥–µ–ª–µ–π `mistral-large` –∏ `mistral-small`).
2. [x] **Verify History Constraints**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `tavily_search` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π —Ä–æ–ª–µ–π —Å–æ–æ–±—â–µ–Ω–∏–π –≤ Mistral (–¥–æ–ø—É—Å–∫–∞–µ—Ç –ª–∏ –æ–Ω —Ä–æ–ª—å `tool` –±–µ–∑ –ø—Ä–µ–¥—à–µ—Å—Ç–≤—É—é—â–µ–≥–æ `tool_calls` –≤ JSON mode). *–°–ø–æ–π–ª–µ—Ä: —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –Ω–µ—Ç, —Ç—Ä–µ–±—É–µ—Ç—Å—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ User.*

---

## Phase 2: Message History Adapter [x]

**Goal**: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è "—Å–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ" –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤.

**Resource Context**:
- üìÑ `src/llm/providers.rs`

**Logic**:
–¢–∞–∫ –∫–∞–∫ –º—ã –æ—Ç–∫–∞–∑—ã–≤–∞–µ–º—Å—è –æ—Ç –Ω–∞—Ç–∏–≤–Ω–æ–≥–æ `tool_calls`, –º–æ–¥–µ–ª—å –±—É–¥–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å JSON –≤ –ø–æ–ª–µ `content`. –°–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, –æ—Ç–≤–µ—Ç—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –Ω–µ –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–æ–ª—å `tool` (–∫–æ—Ç–æ—Ä–∞—è —Ç—Ä–µ–±—É–µ—Ç `tool_call_id`).

**Steps**:
1. [x] **Create Adapter Method**: –í `impl MistralProvider` —Å–æ–∑–¥–∞—Ç—å –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –º–µ—Ç–æ–¥ `prepare_structured_messages`.
    - –í—Ö–æ–¥: `history: &[Message]`.
    - –í—ã—Ö–æ–¥: `Vec<serde_json::Value>`.
    - **Transformation Rules**:
        - `System` -> `System`.
        - `User` -> `User`.
        - `Assistant` (—Å `tool_calls`) -> `Assistant` (—Ç–æ–ª—å–∫–æ `content` —Å JSON).
        - `Tool` -> `User` (—Ñ–æ—Ä–º–∞—Ç: `[Tool Output] <content>`).
2. [x] **Safety Check**: –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç (–∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏—Ö–æ–¥–∏—Ç –∏–∑ `composer.rs`) —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç JSON-—Å—Ö–µ–º—É (—ç—Ç–æ —Ç–∞–∫, —Å–º. `src/agent/prompt/composer.rs`).

---

## Phase 3: Refactor `chat_with_tools` [x]

**Goal**: –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∞–≥–µ–Ω—Ç—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.

**Resource Context**:
- üìÑ `src/llm/providers.rs` (Method: `chat_with_tools`)

**Steps**:
1. [x] **Update Request Body**:
    - –£–¥–∞–ª–∏—Ç—å –ø–æ–ª–µ `tools`.
    - –£–¥–∞–ª–∏—Ç—å –ø–æ–ª–µ `tool_choice`.
    - –î–æ–±–∞–≤–∏—Ç—å `"response_format": { "type": "json_object" }`.
2. [x] **Update Response Parsing**:
    - –ò–∑–º–µ–Ω–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—Ç–≤–µ—Ç–∞. –¢–µ–ø–µ—Ä—å –æ—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤—Å–µ–≥–¥–∞ –≤ `message.content`.
    - –ú–µ—Ç–æ–¥ –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å `ChatResponse` —Å –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º `content` –∏ **–ø—É—Å—Ç—ã–º** `tool_calls` (—Ç–∞–∫ –∫–∞–∫ –ø–∞—Ä—Å–∏–Ω–≥ JSON –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ `Execution Loop`, –∞ –Ω–µ –≤ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–µ).
3. [x] **Clean Up**: –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥ `parse_mistral_response` –∏ `prepare_messages`, –µ—Å–ª–∏ –æ–Ω–∏ –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è (–∏–ª–∏ –ø–æ–º–µ—Ç–∏—Ç—å `#[allow(dead_code)]` –µ—Å–ª–∏ –Ω—É–∂–Ω—ã –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –æ–±—ã—á–Ω–æ–≥–æ —á–∞—Ç–∞).

---

## Phase 4: Integration & Verification [x]

**Goal**: –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ —Å–ª–æ–º–∞–ª–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏—é –∏ Embeddings.

**Resource Context**:
- üìÑ `src/llm/providers.rs`
- üìÑ `src/agent/runner/execution.rs`

**Steps**:
1. [x] **Check Embeddings**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–µ—Ç–æ–¥ `generate_embedding`. –û–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `send_json_request` –∏ —Å–≤–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π endpoint (`/embeddings`). –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ `MistralProvider` –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É–ª –ø–æ–ª—è `api_key` –∏–ª–∏ `http_client`, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∑–¥–µ—Å—å.
2. [x] **Verify Types**: –ó–∞–ø—É—Å—Ç–∏—Ç—å `cargo-check`, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è –≤ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –æ—à–∏–±–æ–∫ —Ç–∏–ø–æ–≤ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–∏–≥–Ω–∞—Ç—É—Ä –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∏—è –º–µ—Ç–æ–¥–æ–≤.
3. [x] **Linter**: –ó–∞–ø—É—Å—Ç–∏—Ç—å `cargo-clippy` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ dead code (—Å—Ç–∞—Ä—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –Ω–∞—Ç–∏–≤–Ω—ã—Ö —Ç—É–ª–æ–≤).

[!NOTE]
`AgentRunner` –≤ `execution.rs` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å `content` –∫–∞–∫ JSON, –µ—Å–ª–∏ `tool_calls` –ø—É—Å—Ç. –≠—Ç–æ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ —Å—Ç—Ä–æ–∫–∞—Ö 132-140 —Ñ–∞–π–ª–∞ `src/agent/runner/execution.rs`. –ù–∞—à–∞ –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ –≤–µ—Ä–Ω—É—Ç—å —Å—ã—Ä–æ–π JSON –≤ `content`.
