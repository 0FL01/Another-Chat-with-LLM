# Blueprint: Sub-Agent Delegation (Refactored Core Architecture)

## Обзор
Реализация механизма делегирования задач от основного агента (Оркестратора) к легковесному саб-агенту через абстракцию ядра исполнения. Этот подход требует рефакторинга текущего `AgentExecutor` для выделения чистой логики исполнения в `AgentRunner`, что позволит запускать изолированные циклы агентов с минимальными накладными расходами.

## 1. Архитектурные изменения

### A. Выделение `AgentRunner` (Core)
Необходимо отделить логику *исполнения* задач от логики *управления сессией и UI*.

**Сущность `AgentRunner`**:
*   **Ответственность**: Чистое исполнение цикла "Восприятие -> Мысль -> Действие".
*   **Изоляция**: Не знает о Telegram, прогресс-барах, `chat_id` или базе данных.
*   **Входные параметры**:
    *   Сконфигурированный `LlmClient` (модель, температура).
    *   Системный промпт (строка).
    *   Набор инструментов (`Vec<ToolDefinition>` + Registry).
    *   Абстракция памяти/контекста.
*   **Ключевые методы**:
    *   `run(task)`: Запускает цикл итераций до получения финального ответа или исчерпания лимитов.
*   **Компоненты внутри**:
    *   `LoopDetector` (обнаружение зацикливаний).
    *   `StructuredOutputParser` (обработка JSON-ответов).
    *   `HookSystem` (базовые хуки жизненного цикла).

### B. Обновление `AgentExecutor` (Orchestrator)
`AgentExecutor` становится высокоуровневой оберткой над `AgentRunner`.

*   **Ответственность**: Интеграция с инфраструктурой приложения.
*   **Функции**:
    *   Управление `AgentSession` (персистентность).
    *   Сборка контекста (Skills, Memory).
    *   Взаимодействие с пользователем (Narrator, отправка событий прогресса в Telegram).
    *   Обработка глобальных таймаутов и отмен.

## 2. Реализация инструмента `delegate_to_sub_agent`

Инструмент выступает в роли моста между Оркестратором и `AgentRunner`.

**Алгоритм работы**:
1.  **Изоляция контекста**: Создание временной сессии (`EphemeralSession`), содержащей только поставленную задачу (без истории основного диалога).
2.  **Конфигурация Runner**:
    *   Инициализация `AgentRunner` с легкой моделью (ZAI GLM-4.5-Air).
    *   Включение строгого JSON-режима (Structured Output) для гарантии валидности ответов.
3.  **Фильтрация инструментов**:
    *   Формирование "белого списка" инструментов на основе аргумента `tools`, переданного Оркестратором.
    *   Блокировка опасных инструментов (например, отправка сообщений пользователю, вызов еще одного саб-агента).
4.  **Исполнение**:
    *   Запуск `runner.run()`.
    *   Ожидание завершения (синхронно для LLM, асинхронно для рантайма).
5.  **Возврат**: Результат работы саб-агента возвращается как текстовый вывод инструмента.

## 3. Интеграция подсистем

### Skills (Навыки)
Система навыков должна поддерживать и обучение Оркестратора, и контекстуализацию Саб-агента.

*   **Skill: `delegation_manager` (для Оркестратора)**
    *   **Цель**: Научить модель распознавать задачи, требующие делегирования.
    *   **Содержание**: Эвристики для делегирования (черновая работа, массовый поиск, чтение больших объемов данных). Примеры правильного вызова `delegate_to_sub_agent` с четкой постановкой задачи.
*   **Skill Injection (для Саб-агента)**
    *   Возможность пробрасывать специфичные скиллы в контекст саб-агента при необходимости (через системный промпт Runner'а).

### Hooks (Хуки)
Использование системы хуков для управления поведением и безопасностью.

*   **Pre-Hook: `ComplexityAnalyzer`**
    *   Анализирует входящий запрос пользователя.
    *   Если задача классифицируется как "исследовательская" или "объемная", добавляет в контекст Оркестратора подсказку (system hint) с рекомендацией рассмотреть делегирование.
*   **Runtime-Hook: `SubAgentSafety`**
    *   Работает внутри Runner'а саб-агента.
    *   Контролирует лимиты токенов и итераций (Fail-fast).
    *   Блокирует рекурсивные вызовы делегирования (глубина стека = 1).

## 4. План реализации (Roadmap)

1.  **Refactoring Phase (Core Extraction)**
    *   Создать модуль `src/agent/runner.rs`.
    *   Мигрировать базовую логику цикла (`run_loop`, `call_llm`, `handle_response`) из `executor.rs` в `runner.rs`, убрав зависимости от `AgentSession` (заменив на трейт контекста).
    *   Адаптировать `AgentExecutor` для использования нового `AgentRunner`.

2.  **Implementation Phase (Tooling)**
    *   Реализовать провайдер `src/agent/providers/delegation.rs`.
    *   Добавить конфигурацию модели `GLM-4.5-Air` (ZAI) в `config.rs`.
    *   Реализовать логику создания и запуска `AgentRunner` внутри провайдера.

3.  **Integration Phase (Logic)**
    *   Создать `skills/delegation.md`.
    *   Реализовать хуки безопасности и анализа сложности.
    *   Написать интеграционные тесты: "Оркестратор вызывает саб-агента для поиска информации".
