# Another Chat TG Bot

Универсальный Telegram-бот с ИИ-ассистентом, поддерживающий множество моделей, типы контента и расширенные функции.

## Описание

Этот проект представляет собой Telegram-бота, который интегрируется с различными API больших языковых моделей (LLM) для предоставления пользователям многофункционального ИИ-ассистента. Бот может обрабатывать текстовые, голосовые, видео сообщения и изображения, работать с документами различных форматов, управлять историей диалога и предоставлять административные функции для управления доступом пользователей.

Бот разработан с использованием Python, библиотеки `python-telegram-bot`, `psycopg2` для взаимодействия с PostgreSQL, и SDK для работы с ИИ-моделями (Groq, Mistral AI, Google Gemini). Развертывание осуществляется с помощью Docker. Скрипт `watchdog_runner.py` обеспечивает автоматический перезапуск при изменениях в коде для удобства разработки.

## Возможности

*   **Поддержка множества LLM:** Интеграция с моделями от Groq, Mistral AI, Google Gemini.
*   **Обработка различных типов ввода:**
    *   Текстовые сообщения.
    *   Голосовые сообщения (распознавание речи через Gemini).
    *   Видео сообщения (извлечение аудио и распознавание через Gemini).
    *   Изображения (анализ и описание через ИИ-модели).
*   **Управление контекстом:**
    *   Сохранение истории диалога в базе данных PostgreSQL.
    *   Возможность очистки контекста диалога.
*   **Гибкость моделей:** Пользователи могут переключаться между доступными моделями.
*   **Персонализация:**
    *   Поддержка пользовательских системных промптов.
    *   Сохранение предпочитаемой модели для каждого пользователя.
*   **Авторизация и роли:**
    *   Доступ к боту только для разрешенных пользователей.
    *   Роли пользователей (ADMIN, USER).
*   **Администрирование:** Команды для добавления и удаления пользователей (только для ADMIN).
*   **Форматирование ответов:** Поддержка Markdown/HTML разметки Telegram (жирный шрифт, курсив, блоки кода, списки).
*   **Обработка длинных сообщений:** Автоматическое разделение длинных ответов на несколько сообщений.
*   **Развертывание с Docker:** Легкое развертывание с использованием Docker.
*   **Логирование:** Подробное логирование с маскированием чувствительных данных (токены, данные БД).
*   **Автоперезапуск при разработке:** Использование `watchdog` для перезапуска при изменении `.py` файлов.

## Необходимые условия

*   **Docker:** [Установите Docker](https://docs.docker.com/engine/install/)
*   **Git:** Для клонирования репозитория.
*   **PostgreSQL:** Работающий экземпляр PostgreSQL, доступный для бота.
*   **API Ключи:** Получите необходимые API ключи для сервисов, которые планируете использовать (см. раздел Конфигурация).

## Установка и запуск

1.  **Клонируйте репозиторий:**
    ```bash
    git clone https://github.com/0FL01/Another-Chat-with-LLM.git
    cd Another-Chat-with-LLM
    ```

2.  **Создайте файл `.env`:**
    Создайте файл `.env` в корневой директории проекта и заполните его необходимыми переменными окружения. Скопируйте структуру из примера ниже.

3.  **Настройте PostgreSQL:**
    Убедитесь, что ваш PostgreSQL сервер запущен и доступен по адресу, указанному в `POSTGRES_HOST`. Создайте базу данных и пользователя, если необходимо, и укажите их данные в `.env`. Бот автоматически создаст необходимые таблицы при первом запуске.

4.  **Соберите и запустите контейнер:**
    ```bash
    docker-compose up --build -d
    ```
    Эта команда соберет Docker образ и запустит контейнер в фоновом режиме (`-d`).

## Конфигурация

Создайте файл `.env` в корневой директории проекта и добавьте следующие переменные:

```dotenv
# Telegram
TELEGRAM_TOKEN=ВАШ_ТЕЛЕГРАМ_БОТ_ТОКЕН
ADMIN_ID=ВАШ_ТЕЛЕГРАМ_ID_АДМИНИСТРАТОРА

# PostgreSQL Database
POSTGRES_DB=имя_вашей_бд
POSTGRES_USER=пользователь_бд
POSTGRES_PASSWORD=пароль_пользователя_бд
POSTGRES_HOST=127.0.0.1 # Или IP/хост вашего сервера PostgreSQL
POSTGRES_PORT=5432     # Порт вашего сервера PostgreSQL

# API Keys (укажите те, которые будете использовать)
GROQ_API_KEY=ВАШ_GROQ_API_КЛЮЧ
MISTRAL_API_KEY=ВАШ_MISTRAL_API_КЛЮЧ
GEMINI_API_KEY=ВАШ_GEMINI_API_КЛЮЧ # Необходим для транскрипции аудио/видео и моделей Gemini

# Опциональные настройки промптов
# SYSTEM_MESSAGE="Ваш кастомный системный промпт по умолчанию"
```

**Важно:**
*   Замените `ВАШ_*` на ваши реальные токены, ID и учетные данные.
*   `ADMIN_ID` - это числовой ID пользователя Telegram, который будет иметь права администратора в боте.
*   Для работы с PostgreSQL при использовании `network_mode: "host"`, `POSTGRES_HOST` должен быть `127.0.0.1` или IP-адрес хост-машины, если PostgreSQL запущен на ней.

## Использование

1.  **Найдите вашего бота в Telegram** по имени пользователя, которое вы указали при создании бота.
2.  **Отправьте команду `/start`**. Если ваш Telegram ID добавлен как `ADMIN_ID` в `.env` или добавлен администратором через команду `/add_user`, бот вас поприветствует.
3.  **Начните общение:** Отправляйте текстовые сообщения, голосовые сообщения, видео, изображения.
4.  **Используйте клавиатуру:**
    *   **"Очистить контекст"**: Удаляет историю текущего диалога для вас.
    *   **"Сменить модель"**: Позволяет выбрать другую доступную ИИ-модель для генерации ответов.
    *   **"Доп функции"**: Открывает меню с дополнительными опциями.
        *   **"Изменить промпт"**: Позволяет установить кастомный системный промпт для ваших диалогов.
        *   **"Назад"**: Возврат в главное меню.

## Доступные модели

*   **Gemini 2.5 Flash** (модель по умолчанию)
*   **Gemini 2.0 Flash**
*   **gpt-oss-120b** (Groq)
*   **Magistral Medium 1.2** (Mistral)

*(Список моделей и их параметры могут изменяться в `config.py`)*

## Команды администратора

**Важно:** По умолчанию бот настроен с авторизацией. Это означает, что доступ к его функциям имеют только администратор (чей Telegram ID указан в переменной `ADMIN_ID` в файле `.env`) и пользователи, которых администратор добавил вручную с ролью `USER`. Следующие команды предназначены для управления этим списком доступа и доступны только пользователям с ролью `ADMIN`:

*   `/add_user <telegram_id> <role>`: Добавляет нового пользователя в список разрешенных с указанной ролью (`USER` или `ADMIN`). Только добавленные пользователи смогут взаимодействовать с ботом.
    *   Пример: `/add_user 123456789 USER`
*   `/remove_user <telegram_id>`: Удаляет пользователя из списка разрешенных, отзывая его доступ к боту.
    *   Пример: `/remove_user 123456789`
*   `/list_users`: Показывает всех пользователей, имеющих доступ к боту, и их роли.
*   `/list_user <telegram_id>`: Показывает роль конкретного пользователя, если он есть в списке доступа.
*   `/healthcheck`: Проверяет состояние бота и его подключений.

## Развертывание

Проект использует Docker для упрощения развертывания.

*   `Dockerfile` описывает многостадийную сборку образа приложения с необходимыми зависимостями для уменьшения размера финального образа.
*   `docker-compose.yml` определяет сервис `another_chat_tg`, который запускает контейнер:
    *   Использует `network_mode: "host"` для прямого доступа к сетевому интерфейсу хоста.
    *   Монтирует файл `.env` внутрь контейнера (только для чтения).
    *   Монтирует папку `logs` для сохранения логов на хост-машине.
    *   Устанавливает политику перезапуска `unless-stopped`.

## Логирование

Бот ведет логи своей работы в папку `logs` (файл `acwl.log`). Логирование настроено с ротацией файлов по времени и маскированием чувствительной информации (токены Telegram, данные для подключения к БД).

## Структура проекта

```
.
├── main.py              # Точка входа приложения
├── handlers.py          # Обработчики Telegram сообщений
├── config.py            # Конфигурация и инициализация API клиентов  
├── database.py          # Функции для работы с PostgreSQL
├── utils.py             # Вспомогательные функции
├── watchdog_runner.py   # Автоперезапуск при разработке
├── requirements.txt     # Python зависимости
├── Dockerfile          # Конфигурация Docker образа
├── docker-compose.yml  # Конфигурация Docker Compose
├── .env                # Переменные окружения (создается пользователем)
├── tests/              # Автоматические тесты
└── logs/               # Папка для логов (создается автоматически)
```
